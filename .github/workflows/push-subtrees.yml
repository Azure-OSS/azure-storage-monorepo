name: Push Subtrees

on:
  push:
    branches:
      - main

jobs:
  push-subtrees:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        subtree:
          - { prefix: "src/Common", repo: "azure-storage-common.git", key: "DEPLOY_KEY_COMMON" }
          - { prefix: "src/Blob", repo: "azure-storage-php.git", key: "DEPLOY_KEY_BLOB" }
          - { prefix: "src/BlobFlysystem", repo: "azure-storage-php-adapter-flysystem.git", key: "DEPLOY_KEY_BLOB_FLYSYSTEM" }
          - { prefix: "src/BlobLaravel", repo: "azure-storage-php-adapter-laravel.git", key: "DEPLOY_KEY_BLOB_LARAVEL" }

    steps:
      - name: Checkout monorepo
        uses: actions/checkout@v3

      - name: Configure Git
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets[matrix.subtree.key] }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Push subtree if changed
        run: |
          set -e

          PREFIX="${{ matrix.subtree.prefix }}"
          REPO="${{ matrix.subtree.repo }}"
          REMOTE_NAME="${REPO%.git}"  # Use repo name (without .git) as remote alias

          # Add remote if it doesn't exist
          if ! git remote | grep -q "^$REMOTE_NAME$"; then
            git remote add $REMOTE_NAME git@github.com:Azure-OSS/$REPO
          fi

          # Split subtree
          SPLIT_BRANCH="split-$REMOTE_NAME"
          git subtree split --prefix=$PREFIX -b $SPLIT_BRANCH || true

          # Push only if there are commits to push
          if git log $REMOTE_NAME/main..$SPLIT_BRANCH --oneline | grep .; then
            echo "Pushing $PREFIX to $REMOTE_NAME..."
            GIT_SSH_COMMAND="ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" git push $REMOTE_NAME $SPLIT_BRANCH:main --force
          else
            echo "No changes in $PREFIX. Skipping push."
          fi

          # Clean up
          git branch -D $SPLIT_BRANCH || true
